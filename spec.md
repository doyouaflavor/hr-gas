# 📋 AI Coding 需求文件

## 專案概述
Google Apps Script 專案，用於管理員工加班與補休記錄的雙向同步與驗證系統。

---

## 系統架構

### 檔案結構
```
主控台.xlsx (主要資料源)
├── 員工清單
├── 總加班記錄
└── 總補修記錄

員工A-2025.xlsx, 員工B-2025.xlsx... (20個檔案)
└── 各月份分頁 (08月, 09月...)
```

### 資料表欄位定義

**員工總表**
```
編號	姓名	表格ID	表格連結	狀態
EX:
E001    張OO    asdfjkl-12345    [連結](https://docs.google.com/spreadsheets/..../edit)  啟用|暫停|已離職
```

**加班統計總表 (主控台)**
```
| 加班編號 | 員工編號 | 姓名 | 日期 | 星期 | 加班類型 | 加班時數 | 已使用補休 | 剩餘可補休 | 狀態 | 資料來源月份 | 用掉補修編號 | 錯誤提示 |
```

**補休申請總表 (主控台)**
```
| 補休編號 | 員工編號 | 姓名 | 申請日期 | 補休日期 | 使用時數 | 對應加班編號 | 備註 | 行政組查閱打勾 | 錯誤提示 |
```

**員工月份分頁**
資料參考 @spreadsheet-personal.png 檔案

---

## 核心需求

### 功能 1: 主控台觸發全員檢查
**入口函數：** `checkAllEmployees()`

**流程：**
1. 從「員工清單」讀取所有啟用員工
2. 對每位員工執行完整檢查
3. 記錄執行結果到「執行紀錄」

---

### 功能 2: 員工表格數據同步檢查
**函數：** `checkEmployeeData(employeeId, employeeFileId)`

**步驟：**

#### 2.1 掃描員工所有月份分頁
- 讀取該員工試算表的所有分頁
- 篩選出符合格式的月份分頁（如 "8月", "9月"）
- 依序處理每個月份

#### 2.2 提取加班資料
從每個月份分頁中提取：
- 日期
- 加班時數（非零值）
- 加班類型（平日/假日/例假日）
- 備註

#### 2.3 比對主控台加班總表
對每筆員工加班記錄：
```
IF 主控台「總加班記錄」中不存在 (員工編號 + 日期) 的記錄
THEN 新增一行到「總加班記錄」
    - 自動產生加班編號（如 "OT-20250801-E001-1": 前綴+日期+員工編號+同一天流水號）
    - 填入：員工編號、姓名、日期、加班時數
    - 已使用補休 = 0
    - 剩餘可補休 = 加班時數
    - 狀態 = "未使用"
    - 資料來源月份 = 該分頁名稱
    - 其他該月表格同一行之資料
```

---

### 功能 3: 反向驗證加班總表
**函數：** `validateOvertimeRecords()`

**目的：** 確保主控台的每筆加班記錄都能在員工檔案中找到對應數據

**流程：**
1. 讀取「總加班記錄」所有資料
2. 對每一筆記錄：
   ```
   根據 員工編號 → 找到員工試算表ID
   根據 資料來源月份 → 找到對應分頁
   根據 日期 → 在該分頁找到對應列
   
   IF 找不到對應資料
   THEN 標記為「資料異常」+ 記錄到錯誤日誌
   ```

---

### 功能 4: 補休與加班配對檢查
**函數：** `matchLeaveWithOvertime()`

**步驟：**

#### 4.1 掃描未配對的補休記錄
```sql
SELECT * FROM 總補修記錄 
WHERE 對應加班編號 IS NULL OR 對應加班編號 = ""
```

#### 4.2 自動配對邏輯
對每筆未配對的補休記錄：

```javascript
1. 取得該員工的所有加班記錄（按日期由舊到新排序）
2. 篩選出「剩餘可補休 > 0」的加班記錄
3. 依序分配：
   
   補休需求時數 = 使用時數
   
   WHILE 補休需求時數 > 0:
       找到最舊的可用加班記錄
       
       IF 該加班記錄剩餘時數 >= 補休需求時數:
           分配全部需求時數到該加班記錄
           更新加班記錄：已使用補休 += 補休需求時數
           更新加班記錄：剩餘可補休 -= 補休需求時數
           補休需求時數 = 0
           
       ELSE:
           分配該加班記錄的全部剩餘時數
           更新加班記錄：已使用補休 = 加班時數
           更新加班記錄：剩餘可補休 = 0
           更新加班記錄：狀態 = "已全數使用"
           補休需求時數 -= 該加班記錄剩餘時數
           
       更新補休記錄：對應加班編號 = 該加班編號
       
   IF 補休需求時數 > 0:
       標記錯誤：「補休時數超過可用加班時數」
```

#### 4.3 更新狀態
```javascript
更新加班記錄狀態：
- 剩餘可補休 = 0 → 狀態 = "已全數使用"
- 剩餘可補休 > 0 但 已使用補休 > 0 → 狀態 = "部分使用"
- 已使用補休 = 0 → 狀態 = "未使用"
```

---

## 執行順序

```
主函數 checkAllEmployees()
│
├─ Step 1: 對每位員工執行
│   └─ checkEmployeeData(employeeId, fileId)
│       ├─ 1.1 掃描月份分頁
│       ├─ 1.2 提取加班資料
│       └─ 1.3 比對並新增到主控台
│
├─ Step 2: 反向驗證
│   └─ validateOvertimeRecords()
│       └─ 檢查主控台每筆加班是否對應到員工資料
│
└─ Step 3: 補休配對
    └─ matchLeaveWithOvertime()
        ├─ 3.1 找出未配對補休
        ├─ 3.2 自動分配到最舊加班
        └─ 3.3 更新剩餘時數與狀態
```

---

## 錯誤處理

### 需要記錄的錯誤情況
1. 員工檔案無法存取（權限問題）
2. 月份分頁格式不正確
3. 加班資料在主控台找不到對應
4. 補休時數超過可用加班時數
5. 資料格式錯誤（日期、數字格式）

### 錯誤記錄格式
```
| 時間戳記 | 錯誤類型 | 員工編號 | 詳細訊息 | 受影響資料 |
```

---

## 技術規格

### 使用工具
- Google Apps Script (clasp)
- SpreadsheetApp API

### 效能考量
- 批次讀寫（避免逐筆操作）
- 使用 `getValues()` 和 `setValues()` 而非 `getValue()` / `setValue()`
- 每位員工處理完記錄一次進度

### 資料安全
- 所有寫入操作要有事前備份機制
- 關鍵操作加入 try-catch
- 失敗時不影響其他員工的處理

---

## 測試案例

### 測試場景 1: 新增加班記錄
```
員工A在 2025-08 分頁有加班 8 小時
主控台「總加班記錄」中沒有這筆資料
→ 應該新增一筆加班記錄，剩餘可補休 = 8
```

### 測試場景 2: 補休自動配對
```
員工A有兩筆加班：
- 2025-08-01: 10小時 (剩餘10)
- 2025-08-05: 8小時 (剩餘8)

員工A申請補休 12 小時
→ 應該先用掉 8/1 的 10小時，再用掉 8/5 的 2小時
→ 8/1 狀態變「已全數使用」，8/5 剩餘6小時
```

### 測試場景 3: 補休超量錯誤
```
員工A只有 5 小時可補休
員工A申請補休 8 小時
→ 應該標記錯誤，不執行配對
```

---

## 輸出要求

### 執行完成後顯示
```
✅ 檢查完成報告
━━━━━━━━━━━━━━━━━━━━
處理員工數：20
新增加班記錄：35 筆
配對補休記錄：12 筆
發現錯誤：2 筆

詳細記錄請查看「執行紀錄」工作表
```

---

## 程式碼結構建議

```javascript
// Code.js

// ===== 主要流程 =====
function checkAllEmployees() { }

// ===== 員工資料檢查 =====
function checkEmployeeData(employeeId, fileId) { }
function scanMonthlySheets(fileId) { }
function extractOvertimeData(sheet) { }
function addOvertimeRecord(record) { }

// ===== 反向驗證 =====
function validateOvertimeRecords() { }

// ===== 補休配對 =====
function matchLeaveWithOvertime() { }
function allocateLeaveToOvertime(leaveRecord) { }
function updateOvertimeStatus(overtimeId) { }

// ===== 工具函數 =====
function getMasterSheet(sheetName) { }
function getEmployeeSheet(fileId, sheetName) { }
function generateOvertimeId(date) { }
function logError(type, employeeId, message) { }
```
